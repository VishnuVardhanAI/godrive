version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: godrive
      POSTGRES_PASSWORD: godrive
      POSTGRES_DB: godrive
    ports: ["5432:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]

  minio:
    image: minio/minio:RELEASE.2024-08-17T01-24-54Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: godrive
      MINIO_ROOT_PASSWORD: godrivepass
      # NATS target for bucket notifications
      MINIO_NOTIFY_NATS_ENABLE_UPLOADS: "on"
      MINIO_NOTIFY_NATS_ADDRESS_UPLOADS: "nats:4222"
      MINIO_NOTIFY_NATS_SUBJECT_UPLOADS: "godrive.uploaded"
    ports: ["9000:9000", "9001:9001"]
    volumes: [miniodata:/data]

  nats:
    image: nats:2.10
    ports: ["4222:4222"]

  jaeger:
    image: jaegertracing/all-in-one:1.58
    ports: ["16686:16686", "4317:4317", "4318:4318"]

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    environment:
      DB_DSN: "postgres://godrive:godrive@postgres:5432/godrive?sslmode=disable"
      JWT_SECRET: "change-me"
    depends_on: [postgres]

  files:
    build:
      context: .
      dockerfile: services/files/Dockerfile
    environment:
      DB_DSN: "postgres://godrive:godrive@postgres:5432/godrive?sslmode=disable"
      STORAGE_ADDR: "storage:50053"   # Files calls Storage for download URLs
    depends_on: [postgres, storage]

  storage:
    build:
      context: .
      dockerfile: services/storage/Dockerfile
    environment:
      S3_ENDPOINT: "minio:9000"
      S3_ACCESS_KEY: "godrive"
      S3_SECRET_KEY: "godrivepass"
      S3_BUCKET: "godrive"
    depends_on: [minio]

  ingest:
    build:
      context: .
      dockerfile: services/ingest/Dockerfile
    environment:
      NATS_URL: "nats://nats:4222"
      FILES_ADDR: "files:50052"   # gRPC endpoint for FilesService
    depends_on: [nats, files]

  gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    environment:
      AUTH_ADDR: "auth:50051"
      FILES_ADDR: "files:50052"
      STORAGE_ADDR: "storage:50053"
      JWT_SECRET: "change-me"
    ports: ["8080:8080"]
    depends_on: [auth, files, storage]

volumes:
  pgdata: {}
  miniodata: {}